<?php
// Conexi贸n a la base de datos
$mysqli = new mysqli("localhost", "usuario", "clave", "nombre_bd");

if ($mysqli->connect_error) {
    die("Error de conexi贸n: " . $mysqli->connect_error);
}

// Obtener el c贸digo desde el formulario
$codigo = $_POST['codigo'] ?? '';

// Buscar al estudiante
$stmt = $mysqli->prepare("SELECT id, nombre FROM estudiantes WHERE codigo = ?");
$stmt->bind_param("s", $codigo);
$stmt->execute();
$resultado = $stmt->get_result();

if ($resultado->num_rows === 0) {
    echo "Estudiante no encontrado.";
} else {
    $estudiante = $resultado->fetch_assoc();
    $id_estudiante = $estudiante['id'];
    $nombre = $estudiante['nombre'];
    
    $fecha = date('Y-m-d');
    $hora = date('H:i:s');

    // Verificar si ya tiene asistencia registrada hoy
    $verificar = $mysqli->prepare("SELECT id FROM asistencia WHERE estudiante_id = ? AND fecha = ?");
    $verificar->bind_param("is", $id_estudiante, $fecha);
    $verificar->execute();
    $verifica_resultado = $verificar->get_result();

    if ($verifica_resultado->num_rows > 0) {
        echo "El estudiante $nombre ya registr贸 asistencia hoy.";
    } else {
        // Registrar la asistencia
        $insertar = $mysqli->prepare("INSERT INTO asistencia (estudiante_id, fecha, hora) VALUES (?, ?, ?)");
        $insertar->bind_param("iss", $id_estudiante, $fecha, $hora);
        if ($insertar->execute()) {
            echo "Asistencia registrada para $nombre a las $hora.";
        } else {
            echo "Error al registrar asistencia.";
        }
    }
}

$mysqli->close();
?>